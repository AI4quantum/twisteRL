name: Build and Deploy Documentation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened, closed]
  workflow_dispatch:

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-docs:
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || github.event.action != 'closed'
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r docs/requirements.txt


    - name: Build documentation
      run: |
        cd docs
        # For PR builds, we'll fix paths after generation since html_baseurl doesn't work reliably
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "Building for PR preview"
          export PR_BUILD=true
        fi
        make html
      env:
        SPHINXOPTS: "--keep-going"

    - name: Upload documentation artifacts
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: docs/_build/html/

  deploy-docs:
    needs: build-docs
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    # Grant GITHUB_TOKEN the permissions required to make a Pages deployment
    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - name: Setup Pages
      uses: actions/configure-pages@v3

    - name: Download documentation artifacts
      uses: actions/download-artifact@v4
      with:
        name: documentation
        path: ./docs

    - name: Upload to GitHub Pages
      uses: actions/upload-pages-artifact@v2
      with:
        path: ./docs

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2

  deploy-pr-preview:
    needs: build-docs
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action != 'closed'
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Download documentation artifacts
      uses: actions/download-artifact@v4
      with:
        name: documentation
        path: ./pr-docs

    - name: Deploy PR Preview
      run: |
        # Configure git
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        # Check if gh-pages branch exists
        if git show-ref --verify --quiet refs/remotes/origin/gh-pages; then
          echo "gh-pages branch exists, checking it out"
          git fetch origin gh-pages:gh-pages
          git checkout gh-pages
        else
          echo "gh-pages branch doesn't exist, creating orphan branch"
          git checkout --orphan gh-pages
          git rm -rf . || true
          echo "# Documentation Previews" > README.md
          git add README.md
          git commit -m "Initialize gh-pages branch"
          git push origin gh-pages
        fi
        
        # Create PR preview directory
        PR_DIR="pr-${{ github.event.number }}"
        rm -rf "$PR_DIR"
        mkdir -p "$PR_DIR"
        
        # Copy built docs to PR directory
        cp -r pr-docs/. "$PR_DIR/"
        
        # Debug: Check what was actually built and copied
        echo "=== Files in pr-docs ==="
        find pr-docs -type f | head -20
        echo "=== Files in $PR_DIR ==="
        find "$PR_DIR" -type f | head -20
        echo "=== Check if static files exist ==="
        ls -la "$PR_DIR/_static/" | head -10 || echo "No _static directory"
        echo "=== Sample HTML content BEFORE path fixing ==="
        head -30 "$PR_DIR/index.html" | grep -E "_static|css|js" || echo "No static references found"
        
        # Fix all relative paths to absolute paths for PR preview
        echo "=== Fixing paths for PR preview ==="
        find "$PR_DIR" -name "*.html" -type f -exec sed -i 's|href="_static/|href="/${{ github.event.repository.name }}/pr-${{ github.event.number }}/_static/|g' {} \;
        find "$PR_DIR" -name "*.html" -type f -exec sed -i 's|src="_static/|src="/${{ github.event.repository.name }}/pr-${{ github.event.number }}/_static/|g' {} \;
        find "$PR_DIR" -name "*.html" -type f -exec sed -i 's|href="_images/|href="/${{ github.event.repository.name }}/pr-${{ github.event.number }}/_images/|g' {} \;
        find "$PR_DIR" -name "*.html" -type f -exec sed -i 's|src="_images/|src="/${{ github.event.repository.name }}/pr-${{ github.event.number }}/_images/|g' {} \;
        find "$PR_DIR" -name "*.css" -type f -exec sed -i 's|url(_static/|url(/${{ github.event.repository.name }}/pr-${{ github.event.number }}/_static/|g' {} \;
        find "$PR_DIR" -name "*.js" -type f -exec sed -i 's|"_static/|"/${{ github.event.repository.name }}/pr-${{ github.event.number }}/_static/|g' {} \;
        find "$PR_DIR" -name "*.js" -type f -exec sed -i "s|'_static/|'/${{ github.event.repository.name }}/pr-${{ github.event.number }}/_static/|g" {} \;
        
        echo "=== Sample HTML content AFTER path fixing ==="
        head -30 "$PR_DIR/index.html" | grep -E "_static|css|js" || echo "No static references found"
        
        # Add and commit
        git add "$PR_DIR"
        git commit -m "Deploy PR #${{ github.event.number }} preview" || echo "No changes to commit"
        git push origin gh-pages

    - name: Comment PR
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.issue.number;
          const previewUrl = `https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/pr-${prNumber}/`;
          
          // Find existing preview comment
          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
          });
          
          const botComment = comments.data.find(comment => 
            comment.user.type === 'Bot' && comment.body.includes('ðŸ“– Documentation Preview')
          );
          
          const body = `ðŸ“– **Documentation Preview**
          
          The documentation for this PR is available (or will be shortly) at:
          ðŸ”— **${previewUrl}**
          
          This preview is automatically updated when you push changes to this PR.`;
          
          if (botComment) {
            // Update existing comment
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: body
            });
          } else {
            // Create new comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });
          }

  cleanup-pr-preview:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Cleanup PR Preview
      run: |
        # Configure git
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        # Check if gh-pages branch exists
        if ! git show-ref --verify --quiet refs/remotes/origin/gh-pages; then
          echo "gh-pages branch doesn't exist, nothing to clean up"
          exit 0
        fi
        
        # Checkout gh-pages branch
        git fetch origin gh-pages:gh-pages
        git checkout gh-pages
        
        # Remove PR preview directory
        PR_DIR="pr-${{ github.event.number }}"
        if [ -d "$PR_DIR" ]; then
          rm -rf "$PR_DIR"
          git add -A
          git commit -m "Remove PR #${{ github.event.number }} preview" || echo "No changes to commit"
          git push origin gh-pages
          echo "Cleaned up preview for PR #${{ github.event.number }}"
        else
          echo "No preview directory found for PR #${{ github.event.number }}"
        fi